import {
  Modal,
  ScrollView,
  StyleSheet,
  Text,
  TouchableOpacity,
  View,
} from "react-native";
import { inventory } from "../data/mockData";

export default function VulnerabilityDetail({ visible, vulnerability, onClose }) {
  if (!vulnerability) return null;

  const asset = inventory.find((a) => a.id === vulnerability.affectedAssetId);

  const severityColors = {
    Critical: "#ff4444",
    High: "#ff8800",
    Medium: "#ffaa00",
    Low: "#88cc00",
  };

  const getDetailedDescription = () => {
    // Descripción detallada basada en el tipo de vulnerabilidad
    const descriptions = {
      "CVE-2021-44228": "Log4Shell es una vulnerabilidad crítica en Apache Log4j que permite la ejecución remota de código. Afecta a millones de aplicaciones en todo el mundo.",
      "CVE-2023-23397": "Vulnerabilidad en Microsoft Outlook que permite elevación de privilegios a través de archivos especialmente diseñados.",
      "CVE-2021-34527": "PrintNightmare es una vulnerabilidad crítica en el servicio de cola de impresión de Windows que permite ejecución remota de código.",
      "CVE-2020-1472": "Zerologon es una vulnerabilidad crítica en el protocolo Netlogon de Windows que permite tomar el control de controladores de dominio.",
      "CVE-2019-19781": "Vulnerabilidad crítica en Citrix ADC y Citrix Gateway que permite ejecución remota de código.",
    };

    return (
      descriptions[vulnerability.cve] ||
      `Vulnerabilidad en ${asset?.name || "sistema desconocido"} con criticidad ${vulnerability.severity} y puntuación CVSS ${vulnerability.cvss}.`
    );
  };

  return (
    <Modal
      visible={visible}
      animationType="slide"
      transparent={false}
      onRequestClose={onClose}
    >
      <View style={styles.modalContainer}>
        <View style={styles.modalHeader}>
          <Text style={styles.modalTitle}>Detalles de Vulnerabilidad</Text>
          <TouchableOpacity style={styles.closeButton} onPress={onClose}>
            <Text style={styles.closeButtonText}>✕</Text>
          </TouchableOpacity>
        </View>

        <ScrollView style={styles.modalContent}>
          {/* Identificación */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Identificación</Text>
            <View style={styles.detailRow}>
              <Text style={styles.label}>CVE:</Text>
              <Text style={styles.value}>{vulnerability.cve}</Text>
            </View>
            <View style={styles.detailRow}>
              <Text style={styles.label}>Nombre:</Text>
              <Text style={styles.value}>{vulnerability.name}</Text>
            </View>
            <View style={styles.detailRow}>
              <Text style={styles.label}>ID Interno:</Text>
              <Text style={styles.value}>{vulnerability.id}</Text>
            </View>
          </View>

          {/* Severidad y Puntuación */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Severidad</Text>
            <View style={styles.detailRow}>
              <Text style={styles.label}>Nivel:</Text>
              <View
                style={[
                  styles.severityBadge,
                  {
                    backgroundColor: severityColors[vulnerability.severity],
                  },
                ]}
              >
                <Text style={styles.severityText}>{vulnerability.severity}</Text>
              </View>
            </View>
            <View style={styles.detailRow}>
              <Text style={styles.label}>CVSS Score:</Text>
              <Text style={[styles.value, { fontWeight: "bold", fontSize: 18 }]}>
                {vulnerability.cvss}/10.0
              </Text>
            </View>
          </View>

          {/* Activo Afectado */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Activo Afectado</Text>
            <View style={styles.detailRow}>
              <Text style={styles.label}>Nombre:</Text>
              <Text style={styles.value}>{asset?.name || "Desconocido"}</Text>
            </View>
            <View style={styles.detailRow}>
              <Text style={styles.label}>ID:</Text>
              <Text style={styles.value}>{vulnerability.affectedAssetId}</Text>
            </View>
            <View style={styles.detailRow}>
              <Text style={styles.label}>Tipo:</Text>
              <Text style={styles.value}>{asset?.type || "N/A"}</Text>
            </View>
            <View style={styles.detailRow}>
              <Text style={styles.label}>SO/Sistema:</Text>
              <Text style={styles.value}>{asset?.os || "N/A"}</Text>
            </View>
          </View>

          {/* Estado */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Estado</Text>
            <View style={styles.detailRow}>
              <Text style={styles.label}>Estado Actual:</Text>
              <Text
                style={[
                  styles.value,
                  {
                    color:
                      vulnerability.status === "Open"
                        ? "#ff4444"
                        : vulnerability.status === "In Progress"
                          ? "#ff8800"
                          : "#88cc00",
                  },
                ]}
              >
                {vulnerability.status}
              </Text>
            </View>
            <View style={styles.detailRow}>
              <Text style={styles.label}>Descubierta:</Text>
              <Text style={styles.value}>{vulnerability.discoveredDate}</Text>
            </View>
          </View>

          {/* Descripción */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Descripción</Text>
            <Text style={styles.description}>{getDetailedDescription()}</Text>
          </View>
        </ScrollView>
      </View>
    </Modal>
  );
}

const styles = StyleSheet.create({
  modalContainer: {
    flex: 1,
    backgroundColor: "#f5f5f5",
  },
  modalHeader: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    backgroundColor: "#003366",
    padding: 15,
    paddingTop: 20,
  },
  modalTitle: {
    color: "#fff",
    fontSize: 18,
    fontWeight: "bold",
  },
  closeButton: {
    padding: 8,
  },
  closeButtonText: {
    color: "#fff",
    fontSize: 24,
    fontWeight: "bold",
  },
  modalContent: {
    flex: 1,
    padding: 20,
  },
  section: {
    backgroundColor: "#fff",
    borderRadius: 8,
    padding: 15,
    marginBottom: 15,
    borderLeftWidth: 4,
    borderLeftColor: "#003366",
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: "bold",
    color: "#003366",
    marginBottom: 12,
  },
  detailRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    paddingVertical: 8,
    borderBottomWidth: 1,
    borderBottomColor: "#f0f0f0",
  },
  label: {
    fontSize: 14,
    fontWeight: "600",
    color: "#555",
    flex: 0.35,
  },
  value: {
    fontSize: 14,
    color: "#333",
    flex: 0.65,
    textAlign: "right",
  },
  severityBadge: {
    paddingHorizontal: 12,
    paddingVertical: 4,
    borderRadius: 4,
  },
  severityText: {
    color: "#fff",
    fontSize: 12,
    fontWeight: "bold",
  },
  description: {
    fontSize: 14,
    color: "#555",
    lineHeight: 22,
  },
});
